<!DOCTYPE html>
<html>
<head>
<title>Flic</title>
<meta charset="utf-8">
<script type="text/javascript" src="http://code.jquery.com/jquery-2.2.3.min.js"></script>
<script type="text/javascript" src="fliclib.js"></script>
<link rel="stylesheet" href="bootstrap.min.css">
<style>
	table { 
		border-collapse: collapse; 
		text-align: center;
		border: none;
	}
	.flic-img {
		width: 60px;
		height: 60px;
		display: inline-block;
	}
	th {
		width: 200px;
		height: 50px;
	}
	.alert-base {
		margin-left: auto;
		margin-right: auto;
		text-align: center;
		width: 600px;
	}
	#video-content {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: black;
	}
	#video-content video {
		width: 100%;
		margin-left: auto;
	    margin-right: auto;
	    display: block;
	}
	.blurred {
		-webkit-filter: blur(10px);
  		-moz-filter: blur(10px);
  		-o-filter: blur(10px);
  		-ms-filter: blur(10px);
  		filter: blur(10px);
	}
	.grayscale {
		filter: grayscale(1);
		-webkit-filter: grayscale(1); 
	 	filter: grayscale(100%); 
	}
	* {
		cursor: none;
	}
</style>
<script type="text/javascript">

setTimeout(function() {
	if (document.getElementById('flicServerState').textContent === 'Connexion en cours') {
		window.location.reload();
	}
}, 5000);

var client = new FlicClient("ws://"+window.location.host+":5553");
var buttonStatus = {
	black: 'up',
	green: 'up',
	blue: 'up',
	white: 'up'
}

client.onReady = function() {
	$("#flicServerState").text("Connecté");
	client.getInfo(function(info) {
		info.bdAddrOfVerifiedButtons.forEach(function(bdAddr) {
			onGotButton(bdAddr);
		});
		if (info.currentlyNoSpaceForNewConnection) {
			$("#maxConnectionsWarning").show();
		}
		$("#bluetoothControllerState").text(translate(info.bluetoothControllerState));
	});
};

client.onClose = function() {
	$("#flicServerState").text("Fermé");
	setTimeout(function() {
		window.location.reload();
	}, 3000)
};

client.onNewVerifiedButton = function(bdAddr) {
	onGotButton(bdAddr);
};

client.onNoSpaceForNewConnection = function(maxConcurrentlyConnectedButtons) {
	$("#maxConnectionsWarning").show();
};

client.onGotSpaceForNewConnection = function(maxConcurrentlyConnectedButtons) {
	$("#maxConnectionsWarning").hide();
};

client.onBluetoothControllerStateChange = function(state) {
	$("#bluetoothControllerState").text(translate(state));
};

function translate(textToTranslate) {
	switch(textToTranslate) {
		case 'Ready': return 'Prêt';
		case 'Disconnected': return 'Déconnecté';
		case 'Conntected': return 'Connecté';
		case 'Attached': return 'Attaché';
		case 'Detached': return 'Détaché';
		default: return textToTranslate;
	}
}

function getFlicColor(address) {
	switch(address) {
		case '80:e4:da:74:22:74': return 'white';
		case '80:e4:da:74:1e:20': return 'black';
		case '80:e4:da:74:22:53': return 'blue';
		case '80:e4:da:74:1f:55': return 'green';
		default: return address;
	}
}

function isVideoShown() {
	return (videoContent.style.display === 'block');
}

function toggleVideo() {
	if (isVideoShown()) {
		videoContent.style.display = 'none';
		video.pause();
		video.currentTime = 0;
	}
	else {
		videoContent.style.display = 'block';
		videoActions('all');
		video.play();
	}
}

function blurVideo(blur) {
	if (blur) {
		video.classList.add('blurred');
	}
	else {
		video.classList.remove('blurred');
	}
}

function grayScaleVideo(gray) {
	if (gray) {
		videoContent.classList.add('grayscale');
	}
	else {
		videoContent.classList.remove('grayscale');
	}
}

function videoActions(buttonColor) {
	switch(buttonColor) {
		case 'all':
			video.muted = (buttonStatus['green'] === 'up');
			blurVideo(buttonStatus['white'] === 'up');
			grayScaleVideo(buttonStatus['blue'] === 'up');
			break;

		case 'green':
			video.muted = (buttonStatus['green'] === 'up');
			break;

		case 'white':
			blurVideo(buttonStatus['white'] === 'up');
			break;

		case 'blue':
			grayScaleVideo(buttonStatus['blue'] === 'up');
			break;
	}
}

function onGotButton(bdAddr) {
	var buttonColor = getFlicColor(bdAddr);
	var node = $("<tr><td class='bdaddr'></td><td class='status'></td><td class='pressed'></td></tr>");
	node.find(".bdaddr").html('<img class="flic-img" src="flic-btns/' + getFlicColor(bdAddr) + '.png">');
	$("#flics").append(node);
	
	var cc = new FlicConnectionChannel(bdAddr, {
		onButtonUpOrDown: function(clickType, wasQueued, timeDiff) {
			if (buttonColor === 'black') {
				if (clickType === 'ButtonDown') {
					window.lastBlackClickedTime = Date.now();
					setTimeout(function() {
						if (window.lastBlackClickedTime !== 0) {
							if (-(window.lastBlackClickedTime - Date.now()) > 1900) {
								toggleVideo();
							}
						}
					}, 2000)
				}
				else if (clickType === 'ButtonUp') {
					window.lastBlackClickedTime = 0;
				}
			}
			if (buttonColor in buttonStatus) {
				buttonStatus[buttonColor] = (clickType === 'ButtonDown' ? 'down':'up');
			}
			if (isVideoShown()) {
				videoActions(buttonColor);
			}

			node.find(".pressed").text(clickType == "ButtonDown" ? "Appuyé" : "");
		},
		onCreateResponse: function(error, connectionStatus) {
			var textStatus = error == "NoError" ? connectionStatus : error;
			node.find(".status").text(translate(textStatus));
		},
		onConnectionStatusChanged: function(connectionStatus, disconnectReason) {
			node.find(".status").text(translate(connectionStatus));
		}
	});
	client.addConnectionChannel(cc);
}

function startScanWizard() {
	$("#addBtn").hide();
	$("#cancelAddBtn").show();
	
	$("#addBtnResult").text("Welcome to the add new button wizard. Press your Flic button to add it.");
	
	var scanWizard = new FlicScanWizard({
		onFoundPrivateButton: function() {
			$("#addBtnResult").text("Your button is private. Hold down for 7 seconds to make it public.");
		},
		onFoundPublicButton: function(bdAddr, name) {
			$("#addBtnResult").text("Found public button " + bdAddr + " (" + name + "). Now connecting...");
		},
		onButtonConnected: function(bdAddr, name) {
			$("#addBtnResult").text("Connected, now verifying and pairing...");
		},
		onCompleted: function(result, bdAddr, name) {
			if (result == "WizardSuccess") {
				$("#addBtnResult").text("Button " + bdAddr + " successfully added!");
			} else if (result != "WizardCancelledByUser") {
				$("#addBtnResult").text("Scan wizard failed: " + result);
			}
			$("#addBtn").show();
			$("#cancelAddBtn").hide();
		}
	});
	client.addScanWizard(scanWizard);
	window.stopScanWizard = function() {
		client.cancelScanWizard(scanWizard);
		$("#addBtnResult").text("");
	};
}

</script>
</head>
<body><br>
<div class="alert alert-info alert-base">
	Pour démarrer la vidéo, appuyez durant 2 secondes sur le bouton noir
</div>
<center>
Serveur flic: <span id="flicServerState">Connexion en cours</span><br>
Contrôleur bluetooth: <span id="bluetoothControllerState"></span><br><br>
</center>

<table border="1" align="center">
	<thead>
		<tr>
			<th>Bouton</th>
			<th>Statut</th>
			<th>Bouton pressé</th>
		</tr>
	</thead>
<tbody id="flics">
</tbody>
</table>
<br>
<div id="video-content">
	<video>
	  <source src="adelente.mp4" type="video/mp4">
	  <span style="color: white;">Your browser does not support the video tag.</span>
	</video>
</div>
<center>
	<input type="button" class="btn btn-primary" value="Ajouter un nouveau bouton" onclick="startScanWizard()" id="addBtn" />
	<input type="button" class="btn btn-danger" value="Annuler l'ajout d'un nouveau bouton" onclick="stopScanWizard()" id="cancelAddBtn" style="display:none" />
	<span id="addBtnResult"></span>
	<span id="maxConnectionsWarning" style="color:red;display:none">Maximum number of connected buttons reached!</span>
</center>

<script>
	var videoContent = document.getElementById('video-content');
	var video = videoContent.getElementsByTagName('video')[0];
</script>

</body>
</html>
